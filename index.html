
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo, BotCommand
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, filters, ContextTypes
import json
import logging
from datetime import datetime, timedelta

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω –æ—Ç @BotFather
BOT_TOKEN = "7500806601:AAG3nSdkrXc6WBQKojXg-Nx6gAAGEcF4v4M"

# URL –≤–∞—à–µ–≥–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
WEBAPP_URL = "https://powergear2024.github.io/snake-game1/"

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–æ–≤
player_stats = {}

class PlayerStats:
    def __init__(self):
        self.total_games = 0
        self.best_score = 0
        self.best_length = 0
        self.best_level = 0
        self.best_combo = 0
        self.total_score = 0
        self.total_food_eaten = 0
        self.achievements = set()
        self.last_played = None
        self.games_today = 0
        self.daily_reset = None

def get_player_stats(user_id):
    if user_id not in player_stats:
        player_stats[user_id] = PlayerStats()
    
    # –°–±—Ä–æ—Å –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    stats = player_stats[user_id]
    today = datetime.now().date()
    if stats.daily_reset != today:
        stats.games_today = 0
        stats.daily_reset = today
    
    return stats

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏–≥—Ä—ã"""
    user = update.effective_user
    chat = update.effective_chat
    stats = get_player_stats(user.id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —á–∞—Ç–∞
    if chat.type == 'private':
        # –õ–∏—á–Ω—ã–π —á–∞—Ç - –ø–æ–ª–Ω–æ–µ –º–µ–Ω—é —Å WebApp
        welcome_text = f"""üåå –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ó–ú–ï–ô–ö–£ MEGA, {user.first_name}! 

üöÄ **–ù–û–í–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:**
üéÆ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
üåü 5 —Ç–∏–ø–æ–≤ –≤–æ–ª—à–µ–±–Ω–æ–π –µ–¥—ã —Å –±–æ–Ω—É—Å–∞–º–∏  
üåÄ –ü–æ—Ä—Ç–∞–ª—ã –¥–ª—è —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏–∏
üî• –°–∏—Å—Ç–µ–º–∞ –∫–æ–º–±–æ –º–Ω–æ–∂–∏—Ç–µ–ª–µ–π
üíé –≠—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏–∑—Ä–∞–∫–∞ –∏ —É—Å–∫–æ—Ä–µ–Ω–∏—è
üèÜ –°–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π

üìä **–í–ê–®–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê:**
üéØ –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {stats.best_score} –æ—á–∫–æ–≤
üêç –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: {stats.best_length}
üöÄ –í—ã—Å—à–∏–π —É—Ä–æ–≤–µ–Ω—å: {stats.best_level}
üî• –õ—É—á—à–µ–µ –∫–æ–º–±–æ: x{stats.best_combo}
üéÆ –ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ: {stats.total_games}

–ì–æ—Ç–æ–≤—ã –ø–æ–∫–æ—Ä–∏—Ç—å –∫–æ—Å–º–æ—Å? üåå"""

        # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ WebApp (—Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ)
        keyboard = [
            [InlineKeyboardButton("üéÆ –ò–ì–†–ê–¢–¨ –í –ó–ú–ï–ô–ö–£ MEGA", web_app=WebAppInfo(url=WEBAPP_URL))],
            [InlineKeyboardButton("üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤", callback_data="leaderboard"),
             InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats")],
            [InlineKeyboardButton("‚ùì –°–ø—Ä–∞–≤–∫–∞", callback_data="help"),
             InlineKeyboardButton("üèÖ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è", callback_data="achievements")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
    else:
        # –ì—Ä—É–ø–ø–∞/–∫–∞–Ω–∞–ª - —É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –º–µ–Ω—é –±–µ–∑ WebApp
        welcome_text = f"""üêç **–ó–ú–ï–ô–ö–ê MEGA –≤ –≥—Ä—É–ø–ø–µ!** üöÄ

–ü—Ä–∏–≤–µ—Ç, {user.first_name}! –Ø - –∏–≥—Ä–æ–≤–æ–π –±–æ—Ç –ó–º–µ–π–∫–∞ MEGA!

üéÆ **–ß—Ç–æ —è —É–º–µ—é:**
‚Ä¢ –í–µ–¥—É —Ä–µ–π—Ç–∏–Ω–≥ –ª—É—á—à–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –≥—Ä—É–ø–ø—ã
‚Ä¢ –ü–æ–∫–∞–∑—ã–≤–∞—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
‚Ä¢ –ü—Ä–æ–≤–æ–∂—É —Ç—É—Ä–Ω–∏—Ä—ã –∏ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è

üåü **–î–ª—è –∏–≥—Ä—ã** –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è: @{context.bot.username}

‚ö° **–ö–æ–º–∞–Ω–¥—ã –≤ –≥—Ä—É–ø–ø–µ:**
/top - üèÜ –†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤ –≥—Ä—É–ø–ø—ã
/stats - üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞  
/rules - üìã –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã
/help - ‚ùì –ü–æ–ª–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞

**–ù–∞—á–Ω–∏—Ç–µ –∏–≥—Ä–∞—Ç—å –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∏ —Å–æ—Ä–µ–≤–Ω—É–π—Ç–µ—Å—å —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –≥—Ä—É–ø–ø—ã!** üèÜ"""

        # –ü—Ä–æ—Å—Ç—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã (–±–µ–∑ WebApp)
        keyboard = [
            [InlineKeyboardButton("üí¨ –ò–≥—Ä–∞—Ç—å –≤ –ª–∏—á–∫–µ", url=f"https://t.me/{context.bot.username}?start=group_{chat.id}")],
            [InlineKeyboardButton("üèÜ –†–µ–π—Ç–∏–Ω–≥ –≥—Ä—É–ø–ø—ã", callback_data="leaderboard"),
             InlineKeyboardButton("üìã –ü—Ä–∞–≤–∏–ª–∞", callback_data="help")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(welcome_text, reply_markup=reply_markup)

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /help - –ø–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞"""
    help_text = """üêç **–°–ü–†–ê–í–ö–ê –ü–û –ó–ú–ï–ô–ö–ï MEGA** üöÄ

üéÆ **–£–ü–†–ê–í–õ–ï–ù–ò–ï:**
‚Ä¢ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –¥–∂–æ–π—Å—Ç–∏–∫ –∏–ª–∏ —Å—Ç—Ä–µ–ª–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚Ä¢ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ - –ø–∞—É–∑–∞/—Å—Ç–∞—Ä—Ç
‚Ä¢ –°–≤–∞–π–ø—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

üçé **–¢–ò–ü–´ –ï–î–´:**
üçé –ö—Ä–∞—Å–Ω—ã–µ —è–±–ª–æ–∫–∏ - +10 –æ—á–∫–æ–≤
üåü –ó–æ–ª–æ—Ç—ã–µ –∑–≤–µ–∑–¥—ã - +25 –æ—á–∫–æ–≤ + –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ
üíé –ê–ª–º–∞–∑—ã - +50 –æ—á–∫–æ–≤ + —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏–∑—Ä–∞–∫–∞  
‚ö° –ú–æ–ª–Ω–∏–∏ - +15 –æ—á–∫–æ–≤ + —É—Å–∫–æ—Ä–µ–Ω–∏–µ
üåÄ –ü–æ—Ä—Ç–∞–ª—ã - +30 –æ—á–∫–æ–≤ + —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è

üî• **–°–ò–°–¢–ï–ú–ê –ö–û–ú–ë–û:**
‚Ä¢ –ë—ã—Å—Ç—Ä–æ–µ –ø–æ–µ–¥–∞–Ω–∏–µ –µ–¥—ã —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–Ω–æ–∂–∏—Ç–µ–ª—å
‚Ä¢ –ö–æ–º–±–æ x3+ –¥–∞–µ—Ç –±–æ–Ω—É—Å–Ω—ã–µ –æ—á–∫–∏
‚Ä¢ –ß–µ–º –±—ã—Å—Ç—Ä–µ–µ –µ–¥–∏—Ç–µ, —Ç–µ–º –±–æ–ª—å—à–µ –æ—á–∫–æ–≤!

üèÜ **–î–û–°–¢–ò–ñ–ï–ù–ò–Ø:**
üçΩÔ∏è –ü–µ—Ä–≤—ã–π –ø–∏—Ä - —Å—ä–µ—Å—Ç—å 15 —Ñ—Ä—É–∫—Ç–æ–≤
üèÜ –ú–∞—Å—Ç–µ—Ä - –Ω–∞–±—Ä–∞—Ç—å 300 –æ—á–∫–æ–≤
üêç –ì–∏–≥–∞–Ω—Ç—Å–∫–∞—è –∑–º–µ—è - –¥–ª–∏–Ω–∞ 20+ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
üí® –î–µ–º–æ–Ω —Å–∫–æ—Ä–æ—Å—Ç–∏ - –¥–æ—Å—Ç–∏—á—å 6 —É—Ä–æ–≤–Ω—è
üî• –ú–∞—Å—Ç–µ—Ä –∫–æ–º–±–æ - –∫–æ–º–±–æ x5

‚ö†Ô∏è **–ü–†–ï–ü–Ø–¢–°–¢–í–ò–Ø:**
üß± –ö—Ä–∞—Å–Ω—ã–µ –±–ª–æ–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 150 –æ—á–∫–æ–≤
üíé –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏–∑—Ä–∞–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —Å–∫–≤–æ–∑—å –Ω–∏—Ö

üåå **–≠–§–§–ï–ö–¢–´:**
‚Ä¢ –ó–≤–µ–∑–¥–Ω–æ–µ –Ω–µ–±–æ –∏ –∫–æ—Å–º–∏—á–µ—Å–∫–∏–µ —Ç—É–º–∞–Ω–Ω–æ—Å—Ç–∏
‚Ä¢ –°–ª–µ–¥—ã –æ—Ç –¥–≤–∏–∂–µ–Ω–∏—è –∑–º–µ–π–∫–∏
‚Ä¢ –ß–∞—Å—Ç–∏—Ü—ã –ø—Ä–∏ –ø–æ–µ–¥–∞–Ω–∏–∏ –µ–¥—ã
‚Ä¢ –°–≤–µ—á–µ–Ω–∏–µ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ–Ω—É—Å–∞—Ö

–£–¥–∞—á–Ω–æ–π –∏–≥—Ä—ã! üçÄ"""
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ update
    if hasattr(update, 'message'):
        await update.message.reply_text(help_text)
    else:
        await update.edit_message_text(help_text)

async def leaderboard(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /top - —Ç–æ–ø –∏–≥—Ä–æ–∫–æ–≤"""
    if not player_stats:
        message_text = "üèÜ –ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∏–≥—Ä–∞–ª! –°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º!"
    else:
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –ª—É—á—à–µ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
        sorted_players = sorted(
            [(user_id, stats) for user_id, stats in player_stats.items()], 
            key=lambda x: x[1].best_score, 
            reverse=True
        )
        
        message_text = "üèÜ **–¢–û–ü 10 –ò–ì–†–û–ö–û–í** üèÜ\n\n"
        
        for i, (user_id, stats) in enumerate(sorted_players[:10], 1):
            try:
                user_info = await context.bot.get_chat(user_id)
                username = user_info.first_name or f"–ò–≥—Ä–æ–∫{user_id}"
            except:
                username = f"–ò–≥—Ä–æ–∫{user_id}"
            
            medal = "ü•á" if i == 1 else "ü•à" if i == 2 else "ü•â" if i == 3 else f"{i}."
            
            message_text += (
                f"{medal} **{username}**\n"
                f"   üéØ {stats.best_score} –æ—á–∫–æ–≤ | üêç {stats.best_length} –¥–ª–∏–Ω–∞\n"
                f"   üöÄ {stats.best_level} —É—Ä–æ–≤–µ–Ω—å | üî• x{stats.best_combo} –∫–æ–º–±–æ\n\n"
            )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ update
    if hasattr(update, 'message'):
        await update.message.reply_text(message_text, parse_mode='Markdown')
    else:
        await update.edit_message_text(message_text, parse_mode='Markdown')

async def stats_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /stats - –ª–∏—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"""
    # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ –∫–æ–º–∞–Ω–¥, —Ç–∞–∫ –∏ callback –∫–Ω–æ–ø–æ–∫
    if hasattr(update, 'effective_user'):
        user = update.effective_user
    else:
        user = update.from_user
    stats = get_player_stats(user.id)
    
    if stats.total_games == 0:
        await update.message.reply_text("üìä –í—ã –µ—â–µ –Ω–µ –∏–≥—Ä–∞–ª–∏! –ù–∞–∂–º–∏—Ç–µ /start —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.")
        return
    
    avg_score = stats.total_score // stats.total_games if stats.total_games > 0 else 0
    
    # –†–∞–Ω–≥ –∏–≥—Ä–æ–∫–∞
    all_scores = [s.best_score for s in player_stats.values() if s.best_score > 0]
    all_scores.sort(reverse=True)
    rank = all_scores.index(stats.best_score) + 1 if stats.best_score in all_scores else len(all_scores) + 1
    
    stats_text = f"""üìä **–°–¢–ê–¢–ò–°–¢–ò–ö–ê {user.first_name}** 

üèÖ **–†–ï–ô–¢–ò–ù–ì:** #{rank} –∏–∑ {len(player_stats)}

üéØ **–†–ï–ö–û–†–î–´:**
‚Ä¢ –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {stats.best_score} –æ—á–∫–æ–≤
‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: {stats.best_length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤  
‚Ä¢ –í—ã—Å—à–∏–π —É—Ä–æ–≤–µ–Ω—å: {stats.best_level}
‚Ä¢ –õ—É—á—à–µ–µ –∫–æ–º–±–æ: x{stats.best_combo}

üìà **–û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:**
‚Ä¢ –í—Å–µ–≥–æ –∏–≥—Ä: {stats.total_games}
‚Ä¢ –ò–≥—Ä —Å–µ–≥–æ–¥–Ω—è: {stats.games_today}
‚Ä¢ –û–±—â–∏–µ –æ—á–∫–∏: {stats.total_score:,}
‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {avg_score} –æ—á–∫–æ–≤

üèÜ **–î–û–°–¢–ò–ñ–ï–ù–ò–Ø:** {len(stats.achievements)}/5

{f"üéÆ –ü–æ—Å–ª–µ–¥–Ω—è—è –∏–≥—Ä–∞: {stats.last_played.strftime('%d.%m %H:%M')}" if stats.last_played else ""}"""
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —á–∞—Ç–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
    if hasattr(update, 'effective_chat'):
        chat_type = update.effective_chat.type
    elif hasattr(update, 'message'):
        chat_type = update.message.chat.type
    else:
        chat_type = 'private'  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
    
    if chat_type == 'private':
        # –õ–∏—á–Ω—ã–π —á–∞—Ç - –∫–Ω–æ–ø–∫–∞ —Å WebApp
        keyboard = [
            [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞", web_app=WebAppInfo(url=WEBAPP_URL))],
            [InlineKeyboardButton("üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤", callback_data="leaderboard")]
        ]
    else:
        # –ì—Ä—É–ø–ø–∞ - –æ–±—ã—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        keyboard = [
            [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å –≤ –ª–∏—á–∫–µ", url=f"https://t.me/{context.bot.username}")],
            [InlineKeyboardButton("üèÜ –†–µ–π—Ç–∏–Ω–≥ –≥—Ä—É–ø–ø—ã", callback_data="leaderboard")]
        ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ update
    if hasattr(update, 'message'):
        await update.message.reply_text(stats_text, reply_markup=reply_markup, parse_mode='Markdown')
    else:
        await update.edit_message_text(stats_text, reply_markup=reply_markup, parse_mode='Markdown')

async def rules_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /rules - –ø—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã"""
    rules_text = """üìã **–ü–†–ê–í–ò–õ–ê –ó–ú–ï–ô–ö–ò MEGA** 

üéØ **–¶–ï–õ–¨ –ò–ì–†–´:**
–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∑–º–µ–π–∫–æ–π, –µ—à—å—Ç–µ –µ–¥—É –∏ –Ω–∞–±–∏—Ä–∞–π—Ç–µ –æ—á–∫–∏, –∏–∑–±–µ–≥–∞—è —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π —Å–æ —Å—Ç–µ–Ω–∞–º–∏, –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏ –∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º —Ç–µ–ª–æ–º.

üêç **–ú–ï–•–ê–ù–ò–ö–ê:**
‚Ä¢ –ó–º–µ–π–∫–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –¥–≤–∏–∂–µ—Ç—Å—è –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
‚Ä¢ –ü—Ä–∏ –ø–æ–µ–¥–∞–Ω–∏–∏ –µ–¥—ã –∑–º–µ–π–∫–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –≤ –¥–ª–∏–Ω—É
‚Ä¢ –°–∫–æ—Ä–æ—Å—Ç—å –∏–≥—Ä—ã —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º
‚Ä¢ –ö–∞–∂–¥—ã–µ 6 —Å—ä–µ–¥–µ–Ω–Ω—ã—Ö —Ñ—Ä—É–∫—Ç–æ–≤ = –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å

üî• **–°–ò–°–¢–ï–ú–ê –ö–û–ú–ë–û:**
‚Ä¢ –°—ä–µ–¥–∞–π—Ç–µ –µ–¥—É –±—ã—Å—Ç—Ä–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –º–Ω–æ–∂–∏—Ç–µ–ª—è
‚Ä¢ –ö–æ–º–±–æ x2 –∏ –≤—ã—à–µ –¥–∞—é—Ç –±–æ–Ω—É—Å–Ω—ã–µ –æ—á–∫–∏
‚Ä¢ –ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø–æ–µ–¥–∞–Ω–∏–µ–º > 3 —Å–µ–∫ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∫–æ–º–±–æ

üåÄ **–ü–û–†–¢–ê–õ–´:**
‚Ä¢ –†–µ–¥–∫–∞—è –µ–¥–∞, —Å–æ–∑–¥–∞—é—â–∞—è 2 –ø–æ—Ä—Ç–∞–ª–∞ –Ω–∞ 15 —Å–µ–∫—É–Ω–¥
‚Ä¢ –í—Ö–æ–¥ –≤ –æ–¥–∏–Ω –ø–æ—Ä—Ç–∞–ª —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤ –¥—Ä—É–≥–æ–π
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π

‚ö° **–ë–û–ù–£–°–ù–´–ï –≠–§–§–ï–ö–¢–´:**
‚Ä¢ üåü –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ - –ø—Ä–æ—â–µ —É–ø—Ä–∞–≤–ª—è—Ç—å
‚Ä¢ üíé –ü—Ä–∏–∑—Ä–∞–∫ - –ø—Ä–æ—Ö–æ–¥–∏—Ç–µ —Å–∫–≤–æ–∑—å —Å—Ç–µ–Ω—ã –∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è  
‚Ä¢ ‚ö° –£—Å–∫–æ—Ä–µ–Ω–∏–µ - –±—ã—Å—Ç—Ä—ã–π –Ω–∞–±–æ—Ä –æ—á–∫–æ–≤

üèÜ **–û–ß–ö–ò:**
‚Ä¢ –û–±—ã—á–Ω–∞—è –µ–¥–∞: +10 –æ—á–∫–æ–≤
‚Ä¢ –ó–æ–ª–æ—Ç–∞—è –µ–¥–∞: +25 –æ—á–∫–æ–≤  
‚Ä¢ –ú–æ–ª–Ω–∏—è: +15 –æ—á–∫–æ–≤
‚Ä¢ –ê–ª–º–∞–∑—ã: +50 –æ—á–∫–æ–≤
‚Ä¢ –ü–æ—Ä—Ç–∞–ª—ã: +30 –æ—á–∫–æ–≤
‚Ä¢ –ö–æ–º–±–æ –º–Ω–æ–∂–∏—Ç–µ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç –±–æ–Ω—É—Å—ã!

–£–¥–∞—á–∏ –≤ –ø–æ–∫–æ—Ä–µ–Ω–∏–∏ –∫–æ—Å–º–æ—Å–∞! üöÄ"""
    
    await update.message.reply_text(rules_text, parse_mode='Markdown')

async def handle_callback_query(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –∫–Ω–æ–ø–æ–∫"""
    query = update.callback_query
    await query.answer()
    
    if query.data == "leaderboard":
        await leaderboard(query, context)
    elif query.data == "stats":
        await stats_command(query, context)
    elif query.data == "help":
        await help_command(query, context)
    elif query.data == "achievements":
        await show_achievements(query, context)

async def show_achievements(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞"""
    # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ –∫–æ–º–∞–Ω–¥, —Ç–∞–∫ –∏ callback –∫–Ω–æ–ø–æ–∫
    if hasattr(update, 'effective_user'):
        user = update.effective_user
    else:
        user = update.from_user
    stats = get_player_stats(user.id)
    
    all_achievements = {
        'first_feast': 'üçΩÔ∏è –ü–µ—Ä–≤—ã–π –ø–∏—Ä - —Å—ä–µ—Å—Ç—å 15 —Ñ—Ä—É–∫—Ç–æ–≤',
        'score_300': 'üèÜ –ú–∞—Å—Ç–µ—Ä - –Ω–∞–±—Ä–∞—Ç—å 300 –æ—á–∫–æ–≤',
        'long_snake': 'üêç –ì–∏–≥–∞–Ω—Ç—Å–∫–∞—è –∑–º–µ—è - –¥–ª–∏–Ω–∞ 20+ —Å–µ–≥–º–µ–Ω—Ç–æ–≤',
        'speed_demon': 'üí® –î–µ–º–æ–Ω —Å–∫–æ—Ä–æ—Å—Ç–∏ - –¥–æ—Å—Ç–∏—á—å 6 —É—Ä–æ–≤–Ω—è',
        'combo_master': 'üî• –ú–∞—Å—Ç–µ—Ä –∫–æ–º–±–æ - –∫–æ–º–±–æ x5'
    }
    
    achieved_text = "üèÖ **–ü–û–õ–£–ß–ï–ù–ù–´–ï –î–û–°–¢–ò–ñ–ï–ù–ò–Ø:**\n"
    locked_text = "\nüîí **–ù–ï –ü–û–õ–£–ß–ï–ù–´:**\n"
    
    for achievement_id, description in all_achievements.items():
        if achievement_id in stats.achievements:
            achieved_text += f"‚úÖ {description}\n"
        else:
            locked_text += f"‚ùå {description}\n"
    
    if len(stats.achievements) == 0:
        achieved_text += "–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π. –ò–≥—Ä–∞–π—Ç–µ –±–æ–ª—å—à–µ!\n"
    
    achievements_text = achieved_text + locked_text + f"\nüèÜ –ü—Ä–æ–≥—Ä–µ—Å—Å: {len(stats.achievements)}/5 –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π"
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —á–∞—Ç–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
    if hasattr(update, 'effective_chat'):
        chat_type = update.effective_chat.type
    elif hasattr(update, 'message'):
        chat_type = update.message.chat.type
    else:
        chat_type = 'private'
    
    if chat_type == 'private':
        # –õ–∏—á–Ω—ã–π —á–∞—Ç - –∫–Ω–æ–ø–∫–∞ —Å WebApp
        keyboard = [
            [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å", web_app=WebAppInfo(url=WEBAPP_URL))]
        ]
    else:
        # –ì—Ä—É–ø–ø–∞ - –æ–±—ã—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞
        keyboard = [
            [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å –≤ –ª–∏—á–∫–µ", url=f"https://t.me/{context.bot.username}")]
        ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ update
    if hasattr(update, 'message'):
        await update.message.reply_text(achievements_text, reply_markup=reply_markup, parse_mode='Markdown')
    else:
        await update.edit_message_text(achievements_text, reply_markup=reply_markup, parse_mode='Markdown')

async def handle_webapp_data(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç WebApp"""
    user = update.effective_user
    stats = get_player_stats(user.id)
    
    try:
        data = json.loads(update.effective_message.web_app_data.data)
        action = data.get('action')
        
        if action == 'game_over':
            score = data.get('score', 0)
            level = data.get('level', 1)
            max_length = data.get('maxLength', 1)
            max_combo = data.get('maxCombo', 0)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            stats.total_games += 1
            stats.games_today += 1
            stats.total_score += score
            stats.total_food_eaten += data.get('totalFoodEaten', 0)  # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥—ã
            stats.last_played = datetime.now()
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∫–æ—Ä–¥—ã
            is_new_record = False
            records_broken = []
            
            if score > stats.best_score:
                stats.best_score = score
                is_new_record = True
                records_broken.append(f"üéØ –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥ –æ—á–∫–æ–≤: {score}")
            
            if max_length > stats.best_length:
                stats.best_length = max_length
                records_broken.append(f"üêç –ù–æ–≤–∞—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: {max_length}")
            
            if level > stats.best_level:
                stats.best_level = level
                records_broken.append(f"üöÄ –ù–æ–≤—ã–π –≤—ã—Å—à–∏–π —É—Ä–æ–≤–µ–Ω—å: {level}")
                
            if max_combo > stats.best_combo:
                stats.best_combo = max_combo
                records_broken.append(f"üî• –ù–æ–≤–æ–µ –ª—É—á—à–µ–µ –∫–æ–º–±–æ: x{max_combo}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            new_achievements = []
            if stats.total_food_eaten >= 15 and 'first_feast' not in stats.achievements:
                stats.achievements.add('first_feast')
                new_achievements.append('üçΩÔ∏è –ü–µ—Ä–≤—ã–π –ø–∏—Ä')
                
            if score >= 300 and 'score_300' not in stats.achievements:
                stats.achievements.add('score_300')
                new_achievements.append('üèÜ –ú–∞—Å—Ç–µ—Ä')
            
            if max_length >= 20 and 'long_snake' not in stats.achievements:
                stats.achievements.add('long_snake')
                new_achievements.append('üêç –ì–∏–≥–∞–Ω—Ç—Å–∫–∞—è –∑–º–µ—è')
            
            if level >= 6 and 'speed_demon' not in stats.achievements:
                stats.achievements.add('speed_demon')
                new_achievements.append('üí® –î–µ–º–æ–Ω —Å–∫–æ—Ä–æ—Å—Ç–∏')
                
            if max_combo >= 5 and 'combo_master' not in stats.achievements:
                stats.achievements.add('combo_master')
                new_achievements.append('üî• –ú–∞—Å—Ç–µ—Ä –∫–æ–º–±–æ')
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if is_new_record:
                message = f"üéâ **–ù–û–í–´–ô –†–ï–ö–û–†–î!** üéâ\n\n"
            else:
                message = f"üéÆ **–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!** \n\n"
            
            message += f"üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç: **{score} –æ—á–∫–æ–≤**\n"
            message += f"üêç –î–ª–∏–Ω–∞: {max_length} | üöÄ –£—Ä–æ–≤–µ–Ω—å: {level}\n"
            message += f"üî• –õ—É—á—à–µ–µ –∫–æ–º–±–æ: x{max_combo}\n\n"
            
            if records_broken:
                message += "üèÜ **–ù–æ–≤—ã–µ —Ä–µ–∫–æ—Ä–¥—ã:**\n" + "\n".join(records_broken) + "\n\n"
            
            if new_achievements:
                message += "üèÖ **–ù–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**\n" + "\n".join(new_achievements) + "\n\n"
            
            # –†–∞–Ω–≥ –∏–≥—Ä–æ–∫–∞
            all_scores = [s.best_score for s in player_stats.values()]
            all_scores.sort(reverse=True)
            rank = all_scores.index(stats.best_score) + 1
            message += f"üìä –í–∞—à —Ä–µ–π—Ç–∏–Ω–≥: **#{rank}** –∏–∑ {len(player_stats)}"
            
            keyboard = [
                [InlineKeyboardButton("üîÑ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞", web_app=WebAppInfo(url=WEBAPP_URL))],
                [InlineKeyboardButton("üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤", callback_data="leaderboard"),
                 InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            await update.effective_message.reply_text(message, reply_markup=reply_markup, parse_mode='Markdown')
            
        elif action == 'share_score':
            score = data.get('score', 0)
            level = data.get('level', 1)
            max_length = data.get('maxLength', 1)
            max_combo = data.get('maxCombo', 0)
            
            share_message = (
                f"üêç –Ø –Ω–∞–±—Ä–∞–ª {score} –æ—á–∫–æ–≤ –≤ –ó–ú–ï–ô–ö–ï MEGA! üöÄ\n"
                f"üéØ –£—Ä–æ–≤–µ–Ω—å {level} | üêç –î–ª–∏–Ω–∞ {max_length} | üî• –ö–æ–º–±–æ x{max_combo}\n\n"
                f"–°–º–æ–∂–µ—à—å –ø–æ–±–∏—Ç—å –º–æ–π —Ä–µ–∫–æ—Ä–¥? üòé"
            )
            
            keyboard = [
                [InlineKeyboardButton("üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ —á–∞—Ç–µ", 
                                    switch_inline_query=share_message)],
                [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å —Å–∞–º–æ–º—É", web_app=WebAppInfo(url=WEBAPP_URL))]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            await update.effective_message.reply_text(
                f"üéâ –û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! {score} –æ—á–∫–æ–≤!\n\n–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º:",
                reply_markup=reply_markup
            )
            
    except json.JSONDecodeError:
        await update.effective_message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –∏–≥—Ä—ã")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ WebApp –¥–∞–Ω–Ω—ã—Ö: {e}")

async def new_chat_member(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —á–∞—Ç"""
    message = update.message
    new_members = message.new_chat_members
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ–±–∞–≤–∏–ª–∏ –ª–∏ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞
    bot_added = any(member.id == context.bot.id for member in new_members)
    
    if bot_added:
        # –ë–æ—Ç–∞ –¥–æ–±–∞–≤–∏–ª–∏ –≤ –≥—Ä—É–ø–ø—É - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        welcome_text = f"""üéâ **–ü—Ä–∏–≤–µ—Ç, {message.chat.title}!** üéâ

üêç –Ø - **–ó–ú–ï–ô–ö–ê MEGA** - —Å–∞–º—ã–π –∫—Ä—É—Ç–æ–π –∏–≥—Ä–æ–≤–æ–π –±–æ—Ç –≤ Telegram!

üöÄ **–ß—Ç–æ —è –ø—Ä–∏–Ω–µ—Å –≤ –≤–∞—à—É –≥—Ä—É–ø–ø—É:**
üèÜ –†–µ–π—Ç–∏–Ω–≥ –ª—É—á—à–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –≥—Ä—É–ø–ø—ã
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ
üéÆ –°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è –∏ —Ç—É—Ä–Ω–∏—Ä—ã
üåü –°–∏—Å—Ç–µ–º—É –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –∏ –Ω–∞–≥—Ä–∞–¥

üéØ **–ö–∞–∫ –Ω–∞—á–∞—Ç—å –∏–≥—Ä–∞—Ç—å:**
1Ô∏è‚É£ –ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ –≤ –ª–∏—á–∫—É: @{context.bot.username}
2Ô∏è‚É£ –ò–≥—Ä–∞–π—Ç–µ –∏ –Ω–∞–±–∏—Ä–∞–π—Ç–µ –æ—á–∫–∏
3Ô∏è‚É£ –°–æ—Ä–µ–≤–Ω—É–π—Ç–µ—Å—å —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –≥—Ä—É–ø–ø—ã!

‚ö° **–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –≥—Ä—É–ø–ø—ã:**
/top - üèÜ –†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤ –≥—Ä—É–ø–ø—ã  
/stats - üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/rules - üìã –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã
/help - ‚ùì –ü–æ–ª–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞

**–ü—É—Å—Ç—å –ª—É—á—à–∏–π –ø–æ–±–µ–¥–∏—Ç!** üèÜ‚ú®"""

        keyboard = [
            [InlineKeyboardButton("üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä–∞—Ç—å", url=f"https://t.me/{context.bot.username}?start=group_{message.chat.id}")],
            [InlineKeyboardButton("üèÜ –†–µ–π—Ç–∏–Ω–≥", callback_data="leaderboard"),
             InlineKeyboardButton("üìã –ü—Ä–∞–≤–∏–ª–∞", callback_data="help")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await message.reply_text(welcome_text, reply_markup=reply_markup)
    
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –æ–±—ã—á–Ω—ã—Ö –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    else:
        for member in new_members:
            if not member.is_bot:
                welcome_text = f"""üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –≥—Ä—É–ø–ø—É, {member.first_name}!

üêç –ó–¥–µ—Å—å –∂–∏–≤–µ—Ç –∏–≥—Ä–æ–≤–æ–π –±–æ—Ç **–ó–ú–ï–ô–ö–ê MEGA**!

üéÆ –•–æ—á–µ—à—å —Å—Ä–∞–∑–∏—Ç—å—Å—è —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –≥—Ä—É–ø–ø—ã? 
–ù–∞–ø–∏—à–∏ –º–Ω–µ –≤ –ª–∏—á–∫—É: @{context.bot.username} –∏ –Ω–∞—á–Ω–∏ –∏–≥—Ä–∞—Ç—å!

üèÜ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ –≥—Ä—É–ø–ø—ã: /top"""

                await message.reply_text(welcome_text)

async def post_init(application):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏"""
    try:
        commands = [
            BotCommand("start", "üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É"),
            BotCommand("help", "‚ùì –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏–≥—Ä–µ"),
            BotCommand("top", "üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤"), 
            BotCommand("stats", "üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"),
            BotCommand("rules", "üìã –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã")
        ]
        await application.bot.set_my_commands(commands)
        print("‚úÖ –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã")
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∞–Ω–¥: {e}")
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏"""
    try:
        commands = [
            BotCommand("start", "üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É"),
            BotCommand("help", "‚ùì –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏–≥—Ä–µ"),
            BotCommand("top", "üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤"), 
            BotCommand("stats", "üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"),
            BotCommand("rules", "üìã –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã")
        ]
        await application.bot.set_my_commands(commands)
        print("‚úÖ –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã")
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∞–Ω–¥: {e}")

async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    logger.warning(f'Update {update} caused error {context.error}')

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    print("üêç –ó–∞–ø—É—Å–∫ Telegram WebApp –±–æ—Ç–∞ –ó–ú–ï–ô–ö–ê MEGA...")
    
    if BOT_TOKEN == "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê":
        print("‚ùå –û–®–ò–ë–ö–ê: –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–º–µ–Ω–∏—Ç—å BOT_TOKEN –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω!")
        print("üìù –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É @BotFather –≤ Telegram")
        return
    
    if WEBAPP_URL == "https://yourusername.github.io/snake-game/index.html":
        print("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–º–µ–Ω–∏—Ç—å WEBAPP_URL –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π URL!")
        print("üåê –†–∞–∑–º–µ—Å—Ç–∏—Ç–µ HTML-—Ñ–∞–π–ª –∏–≥—Ä—ã –Ω–∞ GitHub Pages –∏–ª–∏ –¥—Ä—É–≥–æ–º —Ö–æ—Å—Ç–∏–Ω–≥–µ")
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(BOT_TOKEN).post_init(post_init).build()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("top", leaderboard))
    application.add_handler(CommandHandler("stats", stats_command))
    application.add_handler(CommandHandler("rules", rules_command))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É
    application.add_handler(MessageHandler(filters.StatusUpdate.NEW_CHAT_MEMBERS, new_chat_member))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback –∫–Ω–æ–ø–æ–∫ –∏ WebApp –¥–∞–Ω–Ω—ã—Ö
    application.add_handler(CallbackQueryHandler(handle_callback_query))
    application.add_handler(MessageHandler(filters.StatusUpdate.WEB_APP_DATA, handle_webapp_data))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    application.add_error_handler(error_handler)
    
    print("‚úÖ –ë–æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω!")
    print("üéÆ –ö–æ–º–∞–Ω–¥—ã: /start /help /top /stats /rules")
    print("üöÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –∏–≥—Ä—É —á–µ—Ä–µ–∑ /start")
    print("üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –ø—Ä–æ—Å—Ç—ã–º —Å–ø–æ—Å–æ–±–æ–º
    print("üîÑ –ó–∞–ø—É—Å–∫ polling...")
    try:
        application.run_polling(drop_pending_updates=True)
    except KeyboardInterrupt:
        print("\nüõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: {e}")
        print("üí° –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:")
        print("   1. –¢–æ–∫–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π")
        print("   2. –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç") 
        print("   3. –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ")

if __name__ == "__main__":
    main()
